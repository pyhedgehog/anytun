#!/bin/sh
#
#  anytun
#
#  The secure anycast tunneling protocol (satp) defines a protocol used
#  for communication between any combination of unicast and anycast
#  tunnel endpoints.  It has less protocol overhead than IPSec in Tunnel
#  mode and allows tunneling of every ETHER TYPE protocol (e.g.
#  ethernet, ip, arp ...). satp directly includes cryptography and
#  message authentication based on the methodes used by SRTP.  It is
#  intended to deliver a generic, scaleable and secure solution for
#  tunneling and relaying of packets of any protocol.
#
#
#  Copyright (C) 2007-2009 Othmar Gsenger, Erwin Nindl, 
#                          Christian Pointner <satp@wirdorange.org>
#
#  This file is part of Anytun.
#
#  Anytun is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  any later version.
#
#  Anytun is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with anytun.  If not, see <http://www.gnu.org/licenses/>.
#

TARGET=`uname -s`

EBUILD_COMPAT=0

CXXFLAGS='-g -Wall -O2 -DLOG_SYSLOG -DLOG_FILE -DLOG_STDOUT'
LDFLAGS='-g -Wall -O2 -lboost_thread -lboost_serialization -lboost_system -lboost_date_time -lm'

CRYPTO_LIB='gcrypt'
PASSPHRASE=1
ROUTING=1
USE_LUA=1
LUA_DIR=''
LUA=''
LUAC=''

PREFIX='/usr/local'
BINDIR=''
SBINDIR=''
ETCDIR=''
MANDIR=''
INSTALLMANPAGE=1
EXAMPLESDIR=''
INSTALLEXAMPLES=1

print_usage() {
  echo "configure --help                    print this"
  echo "          --target=<TARGET>         build target i.e. Linux (default: autodetect)"
  echo "          --prefix=<PREFIX>         the installation prefix (default: /usr/local)"
  echo "          --bindir=<DIR>            the path to the bin directory (default: $PREFIX/bin)"
  echo "          --sbindir=<DIR>           the path to the sbin directory (default: $PREFIX/sbin)"
  echo "          --sysconfdir=<DIR>        the path to the system configuration directory (default: $PREFIX/etc"
  echo "          --mandir=<DIR>            the path to the system man pages (default: $PREFIX/share/man)"
  echo "          --no-manpage              dont't install manpages"
  echo "          --examplesdir=<DIR>       the path to the examples files (default: $PREFIX/share/examples)"
  echo "          --no-examples             dont't install example files"
  echo "          --use-ssl-crypto          use ssl crypto library instead of libgcrypt"
  echo "          --no-crypto               disable crypto at all (only NULL cipher)"
  echo "          --disable-passphrase      disable master key and salt passphrase"
  echo "          --enable-passphrase       enable master key and salt passphrase"
  echo "          --disable-routing         disable built-in routing capability"
  echo "          --enable-routing          enable built-in routing capability"
  echo "          --disable-lua             disable lua integration"
  echo "          --enable-lua             enable lua integration"
  echo "          --with-lua=<DIR>          use this lua tree instead of system default"
}

for arg
do
  case $arg in
  --target=*)
    TARGET=${arg#--target=}
  ;;
  --prefix=*)
    PREFIX=${arg#--prefix=}
  ;;
  --bindir=*)
    SBINDIR=${arg#--bindir=}
  ;;
  --sbindir=*)
    SBINDIR=${arg#--sbindir=}
  ;;
  --sysconfdir=*)
    ETCDIR=${arg#--sysconfdir=}
  ;;
  --mandir=*)
    MANDIR=${arg#--mandir=}
  ;;
  --no-manpage)
    INSTALLMANPAGE=0
  ;;
  --examplesdir=*)
    EXAMPLESDIR=${arg#--examplesdir=}
  ;;
  --no-examples)
    INSTALLEXAMPLES=0
  ;;
  --use-ssl-crypto)
    CRYPTO_LIB='ssl'
  ;;
  --no-crypto)
    CRYPTO_LIB='none'
  ;; 
  --enable-passphrase)
    PASSPHRASE=1
  ;;
  --disable-passphrase)
    PASSPHRASE=0
  ;;
  --enable-routing)
    ROUTING=1
  ;;
  --disable-routing)
    ROUTING=0
  ;;
  --enable-lua)
    USE_LUA=1
  ;;
  --disable-lua)
    USE_LUA=0
  ;;
  --with-lua=*)
    LUA_DIR=${arg#--with-lua=}
  ;;
  --ebuild-compat)
    EBUILD_COMPAT=1
  ;;
  --help)
    print_usage
    exit 0
  ;;
  *)
    ERRORS="$ERRORS $arg"
  ;;
  esac
done

if [ -n "$ERRORS" ] && [ $EBUILD_COMPAT -ne 1 ]; then
  for error in $ERRORS; do
    echo "Unknown argument: $error"
  done

  print_usage
  exit 1
fi


rm -f include.mk
case $TARGET in 
	Linux)
		rm -rf tunDevice.cpp
		ln -sf linux/tunDevice.cpp 
    echo "loading Linux specific TUN Device"
    LDFLAGS=$LDFLAGS' -ldl'
	;;
	OpenBSD|FreeBSD|NetBSD|GNU/kFreeBSD)
		rm -rf tunDevice.cpp
		ln -sf bsd/tunDevice.cpp 
    echo "loading BSD specific TUN Device"
    CXXFLAGS=$CXXFLAGS' -I/usr/local/include'
    LDFLAGS=$LDFLAGS' -L/usr/local/lib'
	;;
	*)
		echo "platform not supported"
    exit 1
	;;
esac

case $CRYPTO_LIB in
  gcrypt)
    LDFLAGS=$LDFLAGS' -lgcrypt -lgpg-error'
    echo "using libgcrypt library"
  ;;
  ssl)
    CXXFLAGS=$CXXFLAGS' -DUSE_SSL_CRYPTO'
    LDFLAGS=$LDFLAGS' -lcrypto'
    echo "using ssl crypto library"
  ;;
  none)
    CXXFLAGS=$CXXFLAGS' -DNO_CRYPT'
    echo "disabling crypto"
  ;;
esac

test_lua_version()
{
  LUA_VERSION=`cat $1 | grep "#define LUA_VERSION[ 	]" | cut -f2- | tr -d '"' | sed -e 's/Lua \([0-9][0-9.]*\)/\1/'`
  LUA_VERSION_NUM=`cat $1 | grep "#define LUA_VERSION_NUM" | awk '{ print $3 }'`
  LUA_RELEASE=`cat $1 | grep "#define LUA_RELEASE[ 	]" | cut -f2-`

  if [ $LUA_VERSION_NUM -ge 501 ]; then
    return 1;
  else
    return 0;
  fi
}

if [ $USE_LUA -eq 1 ]; then
  if [ -z "$LUA_DIR" ]; then
    for prefix in /usr /usr/local; do
      if [ -e $prefix/include/lua.h ]; then
        test_lua_version $prefix/include/lua.h
        if [ $? -eq 1 ]; then
          echo "using Lua $LUA_VERSION ($LUA_RELEASE) found at $prefix/include"
          CXXFLAGS="$CXXFLAGS -I$prefix/include"
          LDFLAGS="$LDFLAGS -L$prefix/lib -llua"
          LUA=$prefix/lua
          LUAC=$prefix/luac
          break
        fi
      else
        for dir in `ls -d $prefix/include/lua* 2> /dev/null`; do
          if [ -e $dir/lua.h ]; then
            test_lua_version $dir/lua.h
            if [ $? -eq 1 ]; then
              echo "using Lua $LUA_VERSION ($LUA_RELEASE) found at $dir"
              CXXFLAGS="$CXXFLAGS -I$dir"
              if [ -x "$prefix/bin/lua$LUA_VERSION" ]; then
                LDFLAGS="$LDFLAGS -L$prefix/lib -llua$LUA_VERSION"
                LUA=$prefix/bin/lua$LUA_VERSION
                LUAC=$prefix/bin/luac$LUA_VERSION
              elif [ -x "$prefix/bin/lua-$LUA_VERSION" ]; then
                LDFLAGS="$LDFLAGS -L$prefix/lib -llua-$LUA_VERSION"
                LUA=$prefix/bin/lua-$LUA_VERSION
                LUAC=$prefix/bin/luac-$LUA_VERSION
              else
                echo "ERROR: found lua.h at $dir/lua.h but no matching lua and luac"
                return 1
              fi
              break
            fi
          fi
        done
        if [ -n "$LUAC" ]; then
          break
        fi
      fi
    done

    if [ -z "$LUAC" ]; then
      echo "ERROR: no suitable lua found .. please install lua 5.1 or higher or use --with-lua"
      return 1
    fi

  else
    CXXFLAGS="$CXXFLAGS -I$LUA_DIR/include"
    LDFLAGS="$LDFLAGS $LUA_DIR/lib/liblua.a"
    LUA=$LUA_DIR/bin/lua
    LUAC=$LUA_DIR/bin/luac
  fi
else
  CXXFLAGS=$CXXFLAGS' -DNO_LUA'
fi

if [ $PASSPHRASE -eq 0 ]; then
  CXXFLAGS=$CXXFLAGS' -DNO_PASSPHRASE'
  echo "disabling master key and salt passphrase"
fi

if [ $ROUTING -eq 0 ]; then
  CXXFLAGS=$CXXFLAGS' -DNO_ROUTING'
  echo "disabling built-in routing capability"
fi

if [ -z "$BINDIR" ]; then
  BINDIR=$PREFIX/bin
fi

if [ -z "$SBINDIR" ]; then
  SBINDIR=$PREFIX/sbin
fi

if [ -z "$ETCDIR" ]; then
  ETCDIR=$PREFIX/etc
fi

if [ -z "$MANDIR" ]; then
  MANDIR=$PREFIX/share/man
fi

if [ -z "$EXAMPLESDIR" ]; then
  EXAMPLESDIR=$PREFIX/share/examples
fi

cat >> include.mk <<EOF
# this file was created automatically
# do not edit this file directly 
# use ./configure instead

TARGET = $TARGET
CXX = gcc
CXXFLAGS = $CXXFLAGS
LD = gcc
LDFLAGS = $LDFLAGS
STRIP = strip
INSTALL = install

PREFIX := $PREFIX
BINDIR := $BINDIR
SBINDIR := $SBINDIR
ETCDIR := $ETCDIR
EOF

if [ $INSTALLMANPAGE -eq 1 ]; then
  echo "MANDIR := $MANDIR" >> include.mk
  echo "installing manpage"
else
  echo "not installing manpage"
fi

if [ $INSTALLEXAMPLES -eq 1 ]; then
  echo "EXAMPLESDIR := $EXAMPLESDIR" >> include.mk
  echo "installing example files"
else
  echo "not installing example files"
fi

echo "" >> include.mk

if [ $CRYPTO_LIB = "none" ]; then
  echo "NO_CRYPT_OBJ = 1" >> include.mk
fi

if [ $USE_LUA -eq 1 ]; then
  echo "LUA := $LUA" >> include.mk
  echo "LUAC := $LUAC" >> include.mk
else
  echo "NO_LUA_OBJ = 1" >> include.mk
  echo "disabling lua integration"
fi

exit 0
